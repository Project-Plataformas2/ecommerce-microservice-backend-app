name: Security Scan Pipeline - cloud-config
          
on:
  workflow_dispatch:      # Se ejecuta manualmente desde Actions
          
jobs:
  build-and-scan-cloud-config:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: Build all services with Maven
        # Compila todos los proyectos Maven (necesario si hay dependencias compartidas)
        run: mvn -B clean package -DskipTests
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
          
      - name: Build cloud-config Docker image
        run: |
          DOCKERFILE="./cloud-config/Dockerfile"
          if [ ! -f "$DOCKERFILE" ]; then
            echo "::error::Dockerfile not found for cloud-config ($DOCKERFILE)"
            exit 1
          fi
          # Construye la imagen con el nombre del servicio
          docker build -t cloud-config -f "$DOCKERFILE" .
          
      - name: Scan cloud-config with Trivy
        uses: aquasecurity/trivy-action@0.22.0
        with:
          image-ref: cloud-config
          format: "sarif"
          # ✅ CORRECCIÓN 1: Guardar el archivo SARIF directamente en la raíz de trabajo.
          output: "cloud-config.sarif" 
          exit-code: "0"
          severity: "UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL"
          
      - name: Upload SARIF artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-cloud-config 
          # ✅ CORRECCIÓN 2: Subir SOLAMENTE el archivo.
          path: cloud-config.sarif
          
  # -----------------------------------------------------------
  
  upload-cloud-config:
    needs: build-and-scan-cloud-config
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
          
    steps:
      - name: Download cloud-config artifact
        uses: actions/download-artifact@v4
        with:
          name: trivy-results-cloud-config
          # Path simple de descarga
          path: downloaded-artifacts
          
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        with:
          # ✅ RUTA FINAL: El archivo está directamente bajo el directorio de descarga.
          sarif_file: downloaded-artifacts/cloud-config.sarif
